#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
pcp_listen_addresses = '*'
pcp_port = 9898
socket_dir = '/var/run/pgpool'

# SSL configuration for backend connections
ssl = on
ssl_key = '/etc/ssl/pgpool/client.key'
ssl_cert = '/etc/ssl/pgpool/client.crt'
ssl_ca_cert = '/etc/ssl/pgpool/server.crt'

#------------------------------------------------------------------------------
# BACKEND CONFIGURATION
#------------------------------------------------------------------------------
# Backend 0 - Primary (writes + reads)
backend_hostname0 = '${BACKEND0_HOST}'
backend_port0 = ${BACKEND0_PORT}
backend_weight0 = 1              # Weight 1 = READ + WRITE queries
backend_data_directory0 = '${BACKEND0_DATA_DIR}'
backend_flag0 = '${BACKEND0_FLAG}'
backend_application_name0 = '${BACKEND0_NAME}'

# Backend 1 - Standby (reads)
backend_hostname1 = '${BACKEND1_HOST}'
backend_port1 = ${BACKEND1_PORT}
backend_weight1 = 1              # Equal weight for load balancing
backend_data_directory1 = '${BACKEND1_DATA_DIR}'
backend_flag1 = '${BACKEND1_FLAG}'
backend_application_name1 = '${BACKEND1_NAME}'

# Backend 2 - Standby (reads)
backend_hostname2 = '${BACKEND2_HOST}'
backend_port2 = ${BACKEND2_PORT}
backend_weight2 = 1
backend_data_directory2 = '${BACKEND2_DATA_DIR}'
backend_flag2 = '${BACKEND2_FLAG}'
backend_application_name2 = '${BACKEND2_NAME}'

#------------------------------------------------------------------------------
# RUNNING MODE
#------------------------------------------------------------------------------
backend_clustering_mode = 'streaming_replication'
num_init_children = $PGPOOL_NUM_INIT_CHILDREN
max_pool = $PGPOOL_MAX_POOL
listen_backlog_multiplier = $PGPOOL_LISTEN_BACKLOG_MULTIPLIER
serialize_accept = off

#------------------------------------------------------------------------------
# LOAD BALANCING MODE
#------------------------------------------------------------------------------
load_balance_mode = on
# Use session-level load balancing to keep connection sticky
# This ensures DML queries go to the same backend throughout the session
statement_level_load_balance = on
ignore_leading_white_space = on

# Write/Read split configuration
# With 'transaction', writes in explicit transactions go to primary
# Standalone writes may still be load balanced (application must use transactions)
disable_load_balance_on_write = 'transaction'
dml_adaptive_object_relationship_list = ''
black_function_list = 'nextval,setval,pg_catalog.nextval,pg_catalog.setval,currval,lastval'
white_function_list = ''
black_query_pattern_list = ''
white_query_pattern_list = ''

#------------------------------------------------------------------------------
# STREAMING REPLICATION MODE
#------------------------------------------------------------------------------
sr_check_period = 30
sr_check_user = '${SR_CHECK_USER}'
sr_check_password = '${REPMGR_PASSWORD}'
sr_check_database = '${SR_CHECK_DATABASE}'
delay_threshold = 10485760  # 10MB in bytes

#------------------------------------------------------------------------------
# HEALTH CHECK
#------------------------------------------------------------------------------
health_check_period = 30
health_check_timeout = 10
health_check_user = '${HEALTH_CHECK_USER}'
health_check_password = '${REPMGR_PASSWORD}'
health_check_database = '${HEALTH_CHECK_DATABASE}'
health_check_max_retries = 3
health_check_retry_delay = 5
connect_timeout = 10000

#------------------------------------------------------------------------------
# FAILOVER AND FAILBACK
#------------------------------------------------------------------------------
failover_on_backend_error = off
failover_command = '/usr/local/bin/failover.sh %d %h %p %D %m %H %M %P %r %R %N %S'
failback_command = ''
failover_require_consensus = off
search_primary_node_timeout = 300

#------------------------------------------------------------------------------
# WATCHDOG (for pgpool-II HA)
#------------------------------------------------------------------------------

use_watchdog = ${USE_WATCHDOG}

# This pgpool node
wd_hostname0 = '${WD_HOSTNAME0}'         # Local node
wd_port0 = ${WD_PORT0}
wd_priority0 = ${WD_PRIORITY0}
wd_node_id0 = ${WD_NODE_ID0}

wd_hostname1 = '${WD_HOSTNAME1}'         # Other pgpool node
wd_port1 = ${WD_PORT1}
wd_priority1 = ${WD_PRIORITY1}
wd_node_id1 = ${WD_NODE_ID1}

# Common watchdog settings
wd_authkey = '${WD_AUTHKEY}'
wd_ipc_socket_dir = '${WD_IPC_SOCKET_DIR}'
delegate_ip = ''                  # No VIP in Docker
if_up_cmd = ''
if_down_cmd = ''
arping_cmd = ''

# Watchdog heartbeat
wd_heartbeat_port0 = 9694
wd_heartbeat_keepalive0 = 2
wd_heartbeat_deadtime0 = 30

# Other pgpool monitoring
wd_monitoring_interfaces_list = ''
wd_lifecheck_method = 'heartbeat'
wd_interval = 10

# Virtual IP interface (disabled in Docker)
wd_escalation_command = ''
wd_de_escalation_command = ''

# Watchdog lifecycle
wd_life_point = 3
wd_lifecheck_query = 'SELECT 1'
wd_lifecheck_dbname = 'postgres'
wd_lifecheck_user = '${WD_LIFECHECK_USER}'
wd_lifecheck_password = '${REPMGR_PASSWORD}'

# Other watchdog nodes and heartbeat destinations are generated by the container
# entrypoint from PGPOOL_PEERS so they are not hardcoded here.

#------------------------------------------------------------------------------
# CONNECTION POOL
#------------------------------------------------------------------------------
connection_cache = on
reset_query_list = 'ABORT; DISCARD ALL'

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
log_destination = 'stderr'
log_line_prefix = '%t: pid %p: '
log_connections = off
log_disconnections = off
log_hostname = on
log_statement = off
log_per_node_statement = off
log_client_messages = off
log_standby_delay = 'if_over_threshold'
log_min_messages = warning

#------------------------------------------------------------------------------
# PCP (pgpool Control Protocol)
#------------------------------------------------------------------------------
pcp_socket_dir = '/var/run/pgpool'

#------------------------------------------------------------------------------
# MEMORY CACHE
#------------------------------------------------------------------------------
memory_cache_enabled = off

#------------------------------------------------------------------------------
# MISC
#------------------------------------------------------------------------------
relcache_expire = 0
relcache_size = 256

enable_pool_hba = on
pool_passwd = 'pool_passwd'
authentication_timeout = 60

# Allow clear text password in pool_passwd to work with SCRAM-SHA-256 backends
allow_clear_text_frontend_auth = on
